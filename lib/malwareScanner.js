const xsenv = require('@sap/xsenv')
const cds = require('@sap/cds')
const DEBUG = cds.debug('attachments')
const { SELECT } = cds.ql;

async function scanRequest(Attachments, key) {
  const production = false || cds.env?.production || cds.env?.profiles?.includes('production') || cds.env?.profiles?.includes('hybrid')
  const AttachmentsSrv = await cds.connect.to("attachments")
  
  let draftEntity, activeEntity
  if (Attachments.isDraft) {
    draftEntity = Attachments
    activeEntity = Attachments.actives
  } else {
    activeEntity = Attachments
  }

  let currEntity = draftEntity == undefined ? activeEntity : draftEntity

  if (!production) {
    DEBUG?.('Malware scanning is disabled in local/development environment. Setting scan status to Clean.')
    if (currEntity == draftEntity) {
      currEntity = await _getCurrentEntity(currEntity, activeEntity, key)
    }
    await AttachmentsSrv.update(currEntity, key, { status: "Clean"})
    return
  }
  
  const credentials = _getCredentials()
  if (currEntity == draftEntity) {
    currEntity = await _getCurrentEntity(currEntity, activeEntity, key)
  }
  await AttachmentsSrv.update(currEntity, key, { status: "Scanning" })

  const contentStream = await AttachmentsSrv.get(currEntity, key)
  let fileContent
  try {
    fileContent = await _streamToString(contentStream)
  } catch (err) {
    if (currEntity == draftEntity) {
      currEntity = await _getCurrentEntity(currEntity, activeEntity, key)
    }
    await AttachmentsSrv.update(currEntity, key, { status: "Failed" })
    DEBUG?.("Malware Scanning: Cannot read file content", err)
    return
  }

  let response;
  try {
    response = await fetch(`https://${credentials.uri}/scan`, {
      method: "POST",
      headers: {
        Authorization:
          "Basic " + Buffer.from(`${credentials.username}:${credentials.password}`, "binary").toString("base64"),
      },
      body: fileContent,
    })
  } catch (error) {
    if (currEntity == draftEntity) {
      currEntity = await _getCurrentEntity(currEntity, activeEntity, key)
    }
    await AttachmentsSrv.update(currEntity, key, { status: "Failed" })
    DEBUG?.("Request to malware scanner failed", error)
    return
  }

  try {
    const responseText = await response.json()
    if (currEntity == draftEntity) {
      currEntity = await _getCurrentEntity(currEntity, activeEntity, key)
    }
    await AttachmentsSrv.update(currEntity, key, { status: responseText.malwareDetected ? "Infected" : "Clean"})
  } catch (err) {
    if (currEntity == draftEntity) {
      currEntity = await _getCurrentEntity(currEntity, activeEntity, key)
    }
    await AttachmentsSrv.update(currEntity, key, { status: "Failed" })
    DEBUG?.("Cannot serialize malware scanner response body", err)
  }
}

async function _getCurrentEntity(currEntity, activeEntity, key) {
  let isDraft  = await _isDraft(currEntity, key)
  return isDraft ? currEntity : activeEntity
}

async function _isDraft(Attachments, key) {
  try {
    const result = await SELECT.from(Attachments, key).columns('url')
    return result !== null && result !== undefined
  } catch (err) {
    return false
  }
}


function _getCredentials() {
  return xsenv.serviceCredentials({ label: "malware-scanner" });
}

function _streamToString(stream) {
  const chunks = [];
  return new Promise((resolve, reject) => {
    stream.on('data', (chunk) => chunks.push(Buffer.from(chunk)))
    stream.on('error', (err) => reject(err))
    stream.on('end', () => resolve(Buffer.concat(chunks).toString('utf8')))
  })
}

module.exports = {
  scanRequest
}