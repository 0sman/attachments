const xsenv = require('@sap/xsenv');

async function scanRequest(req) {
  const credentials = _getCredentials();
  let response;
  try {
    response = await fetch(`https://${credentials.uri}/scan`, {
      method: "POST",
      headers: {
        Authorization:
          "Basic " + Buffer.from(`${credentials.username}:${credentials.password}`, "binary").toString("base64"),
      },
      body: req,
    });
  } catch (error) {
    throw new Error("Request to malware scanner failed", error);
  }

  try {
    return { scanStatus: (await response.json()).malwareDetected };
  } catch (err) {
    throw new Error("Cannot serialize malware scanner response body", err);
  }
}

function _getCredentials() {
  return xsenv.serviceCredentials({ label: "malware-scanner" });
}

module.exports = {
  scanRequest
}